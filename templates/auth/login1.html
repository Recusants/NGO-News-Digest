{% extends 'management/management_base.html' %}
{% load static %}

{% block title %}Login - NGO Admin{% endblock %}

{% block content %}
<div class="login-container">
    <!-- LOGIN SECTION -->
    <section class="section auth-section" id="login">
        <div class="section-header">
            <h2 class="section-title">Account Management</h2>
        </div>
        <div class="section-body">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="showAuthTab('forgot')">Forgot Password</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
            </div>
            
            <!-- LOGIN TAB -->
            <div id="loginTab" class="auth-content">
                <form method="post" id="loginForm" class="auth-form">
                    {% csrf_token %}
                    <input type="hidden" name="tab" value="login">
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="id_username">Username</label>
                        <input type="text" 
                               name="username" 
                               id="id_username" 
                               class="form-control" 
                               placeholder="Enter your username"
                               value="{{ form.username.value|default:'' }}"
                               required
                               autofocus>
                        {% if form.username.errors %}
                            <div class="form-error">{{ form.username.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_password">Password</label>
                        <input type="password" 
                               name="password" 
                               id="id_password" 
                               class="form-control" 
                               placeholder="••••••••" 
                               required>
                        {% if form.password.errors %}
                            <div class="form-error">{{ form.password.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group flex align-center space-between">
                        <label class="flex align-center">
                            <input type="checkbox" id="rememberMe" name="remember_me">
                            <span class="text-sm ml-1">Remember me</span>
                        </label>
                        <a href="javascript:void(0)" onclick="showAuthTab('forgot')" class="text-sm text-primary">
                            Forgot password?
                        </a>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        Sign In
                    </button>
                    
                    {% if request.GET.next %}
                        <input type="hidden" name="next" value="{{ request.GET.next }}">
                    {% endif %}
                </form>
            </div>
            
            <!-- FORGOT PASSWORD TAB -->
            <div id="forgotTab" class="auth-content hidden">
                <div class="recovery-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <span class="text-sm">Enter Email</span>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <span class="text-sm">Verify Code</span>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <span class="text-sm">New Password</span>
                    </div>
                </div>
                
                <!-- STEP 1: Email -->
                <div id="step1">
                    <p class="text-muted mb-2">Enter your email address and we'll send you a verification code.</p>
                    <form id="forgotPasswordForm" class="auth-form">
                        <div class="form-group">
                            <label for="recoveryEmail">Email Address</label>
                            <input type="email" id="recoveryEmail" class="form-control" placeholder="your@email.com">
                        </div>
                        
                        <div class="flex gap-1 mt-2">
                            <button type="button" class="btn btn-secondary" onclick="showAuthTab('login')">Back to Login</button>
                            <button type="button" class="btn btn-primary" onclick="goToStep(2)">Send Code</button>
                        </div>
                    </form>
                </div>
                
                <!-- STEP 2: Verification Code -->
                <div id="step2" class="hidden">
                    <p class="text-muted mb-2">Enter the 6-digit code sent to your email.</p>
                    <form id="verifyCodeForm" class="auth-form">
                        <div class="form-group">
                            <label for="verificationCode">Verification Code</label>
                            <div class="flex gap-1">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                                <input type="text" class="form-control text-center" maxlength="1" oninput="moveToNext(this)">
                            </div>
                        </div>
                        
                        <div class="text-sm text-muted mb-2">
                            Didn't receive code? 
                            <a href="#" onclick="resendCode()">Resend</a>
                            <span id="countdown">(60s)</span>
                        </div>
                        
                        <div class="flex gap-1 mt-2">
                            <button type="button" class="btn btn-secondary" onclick="backToStep1()">Back</button>
                            <button type="button" class="btn btn-primary" onclick="goToStep(3)">Verify Code</button>
                        </div>
                    </form>
                </div>
                
                <!-- STEP 3: New Password -->
                <div id="step3" class="hidden">
                    <p class="text-muted mb-2">Create a new secure password.</p>
                    <form method="post" id="newPasswordForm" class="auth-form">
                        {% csrf_token %}
                        <input type="hidden" name="tab" value="password_reset">
                        
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" 
                                   name="new_password1" 
                                   id="newPassword" 
                                   class="form-control" 
                                   placeholder="••••••••"
                                   required>
                            <div class="text-sm text-muted mt-1">
                                Password must be at least 8 characters with uppercase, lowercase, and numbers.
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" 
                                   name="new_password2" 
                                   id="confirmPassword" 
                                   class="form-control" 
                                   placeholder="••••••••"
                                   required>
                        </div>
                        
                        <div class="flex gap-1 mt-2">
                            <button type="button" class="btn btn-secondary" onclick="backToStep2()">Back</button>
                            <button type="submit" class="btn btn-primary">Reset Password</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- REGISTER TAB -->
            <div id="registerTab" class="auth-content hidden">
                <p class="text-muted mb-2">Contact your system administrator to create a new account.</p>
                <form class="auth-form">
                    <div class="form-group">
                        <label>Contact Administrator</label>
                        <div class="p-2 bg-blue-50 rounded-lg">
                            <p class="text-sm mb-1">Email: admin@ngo.org</p>
                            <p class="text-sm mb-1">Phone: +1 (555) 123-4567</p>
                            <p class="text-sm">Office Hours: Mon-Fri, 9AM-5PM</p>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary w-100" onclick="showAuthTab('login')">
                        Back to Login
                    </button>
                </form>
            </div>
        </div>
    </section>
</div>

<style>
    /* HIDE HEADER AND SIDEBAR FOR LOGIN PAGE */
    .header,
    .sidebar,
    .sidebar-toggle {
        display: none !important;
    }
    
    /* Adjust main content to full screen */
    .main-content {
        margin-left: 0 !important;
        margin-top: 0 !important;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
    }
    
    /* Style the login container */
    .login-container {
        width: 100%;
        max-width: 800px;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        padding: 2rem;
    }

    /* Auth Tabs */
    .auth-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 2rem;
    }
    
    .auth-tab {
        padding: 1rem 2rem;
        background: none;
        border: none;
        font-size: 1rem;
        color: #666;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: var(--transition);
    }
    
    .auth-tab:hover {
        color: var(--primary);
    }
    
    .auth-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        font-weight: 600;
    }
    
    /* Auth Content */
    .auth-content {
        padding: 1rem 0;
    }
    
    .auth-form {
        max-width: 400px;
        margin: 0 auto;
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--dark);
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-family: inherit;
        font-size: 1rem;
        transition: var(--transition);
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-control.text-center {
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: 2px;
    }
    
    .form-error {
        color: var(--danger);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Password Recovery Steps */
    .recovery-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 2rem;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .step.active .step-number {
        background: var(--primary);
        color: white;
        transform: scale(1.1);
    }
    
    .step span {
        font-size: 0.75rem;
        color: var(--secondary);
    }
    
    .step.active span {
        color: var(--primary);
        font-weight: 500;
    }
    
    /* Alert Styles */
    .alert {
        border-radius: var(--radius);
        border: none;
        margin-bottom: 1.5rem;
        padding: 1rem;
        animation: slideIn 0.3s ease;
    }
    
    .alert-success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .alert-danger {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .alert-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .alert-info {
        background: #dbeafe;
        color: #1e40af;
    }
    
    @keyframes slideIn {
        from {
            transform: translateY(-10px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }
        
        .login-container {
            padding: 1rem;
        }
        
        .auth-tabs {
            flex-direction: column;
        }
        
        .auth-tab {
            text-align: center;
            border-bottom: none;
            border-left: 3px solid transparent;
        }
        
        .auth-tab.active {
            border-left-color: var(--primary);
            border-bottom: none;
        }
        
        .recovery-steps {
            flex-direction: column;
            gap: 1rem;
        }
        
        .step {
            flex-direction: row;
            gap: 1rem;
        }
    }
</style>

<script>
    // Auth tab switching
    function showAuthTab(tabName) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activate clicked tab
        event.target.classList.add('active');
        
        // Show/hide content
        document.getElementById('loginTab').classList.add('hidden');
        document.getElementById('forgotTab').classList.add('hidden');
        document.getElementById('registerTab').classList.add('hidden');
        
        document.getElementById(tabName + 'Tab').classList.remove('hidden');
        
        // Reset recovery steps if showing forgot password
        if (tabName === 'forgot') {
            resetRecoverySteps();
        }
        
        // Focus on first input field
        setTimeout(() => {
            const firstInput = document.querySelector(`#${tabName}Tab input`);
            if (firstInput) firstInput.focus();
        }, 100);
    }

    // Password recovery steps
    let recoveryStep = 1;
    let countdownTimer = null;
    let countdownSeconds = 60;

    function resetRecoverySteps() {
        recoveryStep = 1;
        document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active');
        });
        document.querySelector('.step[data-step="1"]').classList.add('active');
        
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.add('hidden');
        
        if (countdownTimer) {
            clearInterval(countdownTimer);
        }
    }

    function goToStep(step) {
        recoveryStep = step;
        
        // Update step indicators
        document.querySelectorAll('.step').forEach(s => {
            s.classList.remove('active');
        });
        document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
        
        // Show/hide forms
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.add('hidden');
        document.getElementById(`step${step}`).classList.remove('hidden');
        
        // Start countdown for step 2
        if (step === 2) {
            startCountdown();
        }
        
        // Focus on first input field
        setTimeout(() => {
            const firstInput = document.querySelector(`#step${step} input`);
            if (firstInput) firstInput.focus();
        }, 100);
    }

    function backToStep1() {
        goToStep(1);
    }

    function backToStep2() {
        goToStep(2);
    }

    function startCountdown() {
        countdownSeconds = 60;
        const countdownElement = document.getElementById('countdown');
        
        if (countdownTimer) {
            clearInterval(countdownTimer);
        }
        
        countdownTimer = setInterval(() => {
            countdownSeconds--;
            countdownElement.textContent = `(${countdownSeconds}s)`;
            
            if (countdownSeconds <= 0) {
                clearInterval(countdownTimer);
                countdownElement.textContent = '(Expired)';
            }
        }, 1000);
    }

    function resendCode() {
        if (countdownSeconds > 0) {
            showSweetAlert('Please wait', `Please wait ${countdownSeconds} seconds before requesting a new code.`, 'warning');
            return;
        }
        
        const email = document.getElementById('recoveryEmail').value;
        if (!email) {
            showSweetAlert('Email Required', 'Please enter your email address first.', 'error');
            return;
        }
        
        showLoadingAlert('Sending new verification code...');
        
        // Simulate API call
        setTimeout(() => {
            closeLoadingAlert();
            showSweetAlert('Code Sent', 'A new verification code has been sent to your email.', 'success');
            startCountdown();
        }, 1500);
    }

    // Move to next input field for verification code
    function moveToNext(input) {
        if (input.value.length === 1) {
            const next = input.nextElementSibling;
            if (next && next.tagName === 'INPUT') {
                next.focus();
            } else {
                // If this is the last input, you can auto-submit
                const allFilled = Array.from(document.querySelectorAll('#step2 input')).every(inp => inp.value.length === 1);
                if (allFilled) {
                    // Auto-verify after a short delay
                    setTimeout(() => {
                        verifyCode();
                    }, 300);
                }
            }
        }
    }

    function verifyCode() {
        const codeInputs = document.querySelectorAll('#step2 input');
        const code = Array.from(codeInputs).map(input => input.value).join('');
        
        if (code.length !== 6) {
            showSweetAlert('Invalid Code', 'Please enter the complete 6-digit code.', 'error');
            return;
        }
        
        showLoadingAlert('Verifying code...');
        
        // Simulate API verification
        setTimeout(() => {
            closeLoadingAlert();
            goToStep(3);
        }, 1500);
    }

    // Handle password reset form submission
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordForm = document.getElementById('newPasswordForm');
        if (newPasswordForm) {
            newPasswordForm.addEventListener('submit', function(e) {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    showSweetAlert('Passwords do not match', 'Please make sure both passwords are the same.', 'error');
                    return;
                }
                
                // Basic password strength validation
                if (newPassword.length < 8) {
                    e.preventDefault();
                    showSweetAlert('Weak Password', 'Password must be at least 8 characters long.', 'error');
                    return;
                }
                
                if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(newPassword)) {
                    e.preventDefault();
                    showSweetAlert('Weak Password', 'Password must contain uppercase, lowercase letters, and numbers.', 'error');
                    return;
                }
                
                showLoadingAlert('Resetting password...');
                // Form will continue with normal submission
            });
        }
        
        // Remember me functionality
        const rememberCheckbox = document.getElementById('rememberMe');
        const usernameField = document.getElementById('id_username');
        
        if (rememberCheckbox && usernameField) {
            // Load remembered username from localStorage
            const rememberedUsername = localStorage.getItem('rememberedUsername');
            if (rememberedUsername) {
                usernameField.value = rememberedUsername;
                rememberCheckbox.checked = true;
            }
            
            // Save username when checkbox is checked and user types
            usernameField.addEventListener('input', function() {
                if (rememberCheckbox.checked) {
                    localStorage.setItem('rememberedUsername', this.value);
                }
            });
            
            rememberCheckbox.addEventListener('change', function() {
                if (this.checked && usernameField.value) {
                    localStorage.setItem('rememberedUsername', usernameField.value);
                } else {
                    localStorage.removeItem('rememberedUsername');
                }
            });
        }
        
        // Password toggle for login form
        const passwordField = document.getElementById('id_password');
        if (passwordField) {
            // Add toggle button
            const passwordWrapper = passwordField.parentNode;
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'btn btn-outline-secondary btn-sm';
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
            toggleBtn.style.cssText = `
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
                z-index: 5;
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            `;
            
            passwordWrapper.style.position = 'relative';
            passwordField.style.paddingRight = '50px';
            passwordWrapper.appendChild(toggleBtn);
            
            toggleBtn.addEventListener('click', function() {
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
        }
        
        // Auto-focus on first input when tab changes
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.textContent.toLowerCase().replace(' ', '');
                setTimeout(() => {
                    const firstInput = document.querySelector(`#${tabName}Tab input`);
                    if (firstInput) firstInput.focus();
                }, 100);
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Tab switching with arrow keys
            if (e.altKey && (e.key === '1' || e.key === '2' || e.key === '3')) {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                const tabs = document.querySelectorAll('.auth-tab');
                if (tabs[tabIndex]) {
                    tabs[tabIndex].click();
                }
            }
            
            // Enter key submits forms
            if (e.key === 'Enter' && !e.target.matches('textarea, select')) {
                const activeTab = document.querySelector('.auth-tab.active').textContent.trim().toLowerCase();
                if (activeTab === 'login') {
                    document.querySelector('#loginForm button[type="submit"]').click();
                } else if (activeTab === 'forgot') {
                    const currentStep = recoveryStep;
                    if (currentStep === 1) {
                        document.querySelector('#step1 .btn-primary').click();
                    } else if (currentStep === 2) {
                        document.querySelector('#step2 .btn-primary').click();
                    } else if (currentStep === 3) {
                        document.querySelector('#step3 .btn-primary').click();
                    }
                }
            }
        });
    });
</script>
{% endblock %}