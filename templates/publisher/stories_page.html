{% extends 'partials/base.html' %}

{% block title %}NGO News Digest - Home{% endblock %}
{% block content %}
    {% include 'partials/header.html' %}
    <section id="stories" class="section stories-section">
        <div class="container">
            <h2 class="section-title">NGO Success Stories</h2>
            
            <div class="stories-filters">
                <button class="filter-btn active" data-filter="all">All Stories</button>
                <button class="filter-btn" data-filter="health">Health & WASH</button>
                <button class="filter-btn" data-filter="agriculture">Agriculture</button>
                <button class="filter-btn" data-filter="education">Education</button>
                <button class="filter-btn" data-filter="livelihoods">Livelihoods</button>
            </div>
            
            <div class="stories-grid" id="stories-grid">
                <div class="story-card" data-category="health">
                    <img src="https://images.unsplash.com/photo-1576765974257-b414b9ea0051?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Maternal Health" class="story-image">
                    <div class="story-content">
                        <div class="story-meta">
                            <span class="story-category">Health & WASH</span>
                            <span>May 10, 2023</span>
                        </div>
                        <h3 class="story-title">Maternal Health Program Reduces Mortality by 40%</h3>
                        <p class="story-excerpt">Partnership between Ministry of Health and NGO consortium trains midwives and equips clinics in 5 provinces.</p>
                        <div class="story-footer">
                            <span class="story-author">By Dr. Lisa Mangwana</span>
                            <div class="share-buttons">
                                <button class="share-btn" data-platform="share"><i class="fas fa-share-alt"></i></button>
                                <button class="share-btn" data-platform="facebook"><i class="fab fa-facebook-f"></i></button>
                                <button class="share-btn" data-platform="twitter"><i class="fab fa-twitter"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="story-card" data-category="education">
                    <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="School Children" class="story-image">
                    <div class="story-content">
                        <div class="story-meta">
                            <span class="story-category">Education</span>
                            <span>May 8, 2023</span>
                        </div>
                        <h3 class="story-title">Digital Learning Reaches 10,000 Rural Students</h3>
                        <p class="story-excerpt">Save the Children's tablet-based learning program bridges the education gap in remote communities.</p>
                        <div class="story-footer">
                            <span class="story-author">By Farai Chikwava</span>
                            <div class="share-buttons">
                                <button class="share-btn" data-platform="share"><i class="fas fa-share-alt"></i></button>
                                <button class="share-btn" data-platform="facebook"><i class="fab fa-facebook-f"></i></button>
                                <button class="share-btn" data-platform="twitter"><i class="fab fa-twitter"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <div href="" class="read-more-btn" id="read-more-stories-btn">
                    <i class="fas fa-book-open"></i> More Stories
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // State variables
        let currentPage = 1;
        let pageSize = 6;
        let storyCategory = "";
        let sortBy = 'created_at';
        let sortOrder = 'desc';

        $(document).ready(function() {
            clearStories()
            getStories()
        })

        function clearStories(){
            const storiesGrid = $('#stories-grid');
            storiesGrid.empty();
        }


        function getStories(){
            let loadingAlert = Swal.fire({
                title: 'Loading...',
                text: 'Please wait while we fetch stories',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            $.ajax({
                url: '{% url "stories" %}',
                method: 'GET',
                dataType: 'json',
                data: {
                    page: currentPage,
                    page_size: pageSize,
                    category: storyCategory,
                    sort_by: sortBy,
                    sort_order: sortOrder
                },
                success: function(responseData) {
                    loadingAlert.close();
                    renderStories(responseData.stories)
                },
                error: function(jqXHR) {
                    Swal.fire({
                        title: 'Error',
                        text: jqXHR.responseJSON?.error || 'Server error. Try again',
                        icon: 'error'
                    });
                },
            })
        }

        function renderStories(stories){
            const storiesGrid = $('#stories-grid');


            
            if (stories.length < pageSize ) {
                $('#read-more-stories-btn').hide();
            }


            if (stories.length === 0 && currentPage == 1 ) {
                storiesGrid.html(`
                    <div class="story-card no-stories-card text-center">
                        <div class="story-image-placeholder no-stories-image">
                            <i class="fas fa-inbox fa-3x"></i>
                        </div>
                        
                        <div class="story-content">
                            <div class="story-meta justify-content-center mb-3">
                                <span class="story-category no-stories-category">
                                    <i class="fas fa-exclamation-circle me-1"></i>Empty
                                </span>
                            </div>
                            
                            <h3 class="story-title no-stories-title mb-3">
                                No Stories Available
                            </h3>
                            
                            <p class="story-excerpt no-stories-excerpt mb-4">
                                There are no stories matching your criteria.<br>
                                Try adjusting your filters or check back later.
                            </p>
                            
                            <div class="story-footer">
                                <button class="btn btn-outline-primary" onclick="clearFilters()">
                                    <i class="fas fa-filter me-1"></i>Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                return;
            }

            
            stories.forEach(story => {
                storiesGrid.append(`
                    <div class="story-card" data-category="health">
                        <img src="https://images.unsplash.com/photo-1576765974257-b414b9ea0051?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Maternal Health" class="story-image">
                        <div class="story-content">
                            <div class="story-meta">
                                <span class="story-category">Health & WASH</span>
                                <span>May 10, 2023</span>
                            </div>
                            <h3 class="story-title">Maternal Health Program Reduces Mortality by 40%</h3>
                            <p class="story-excerpt">Partnership between Ministry of Health and NGO consortium trains midwives and equips clinics in 5 provinces.</p>
                            <div class="story-footer">
                                <span class="story-author">By Dr. Lisa Mangwana</span>
                                <div class="share-buttons">
                                    <button class="share-btn" data-platform="share"><i class="fas fa-share-alt"></i></button>
                                    <button class="share-btn" data-platform="facebook"><i class="fab fa-facebook-f"></i></button>
                                    <button class="share-btn" data-platform="twitter"><i class="fab fa-twitter"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `)
            })
        }


        /*EVENT LISTNERS -------------------------------------------------------------------------------------------------------------->>*/
        $('#read-more-stories-btn').on('click', function() {
            currentPage = currentPage + 1
            getStories()
        })
        /*EVENT LISTNERS --------------------------------------------------------------------------------------------------------------<<*/

        

    </script>
    {% include 'partials/footer.html' %}
{% endblock %}

