{% extends 'partials/base.html' %}
{% load static %}

{% block title %}NGO News Digest - Stories{% endblock %}

{% block content %}
    {% include 'partials/header.html' %}
    <main id="pageContent">
        <section id="stories" class="page-section">
            <div class="container section py-2">
                <h1>Stories & Articles</h1>
                <p class="mb-2">Explore the latest stories from Zimbabwe's civil society sector.</p>
                
                <div class="filter-section">
                    <div class="filter-group">
                        <span class="filter-label">Filter by:</span>
                        <button class="filter-btn active" data-filter="all">All</button>
                        {% for category in categories %}
                            <button class="filter-btn" data-filter="{{ category.name }}">{{ category.name }}</button>
                        {% endfor %}
                        
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="storySearch" placeholder="Search stories...">
                        </div>
                    </div>
                </div>
                
                <div class="content-grid" id="storiesList">
                    <!-- Stories loaded via JS -->
                </div>
                <center id="more-stories-btn-container">
                    <div class="text-center mt-2">
                        <button id="more-stories-btn" class="btn btn-small" data-page="stories">More Stories</button>
                    </div>
                </center>
                
                <div class="pagination" id="storiesPagination">
                    <!-- Pagination loaded via JS -->
                </div>
            </div>
        </section>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            var page = 1
            var page_size = 9
            var category = "All"

            clearStoriesGrid()
            loadStories(page, page_size, category)


            /*-----------------------------------------------------------------------------------------------------------
            EVENTS >>>>>
            -------------------------------------------------------------------------------------------------------------*/

            $('#more-stories-btn').on('click', function() {
                page++
                loadStories(page, page_size, category)
            });

            /*-----------------------------------------------------------------------------------------------------------
            EVENTS <<<<<
            -------------------------------------------------------------------------------------------------------------*/
        

            function loadStories(page, page_size, category){
                $.ajax({
                    url: "{% url 'stories' %}",
                    data: {
                        page: page,
                        page_size: page_size,
                        category: category,
                     },
                    success: function(responseData) {
                        const storiesGrid = $('#storiesList');
                        var stories = responseData.stories
                        

                        if (stories.length < page_size){
                            $('#more-stories-btn-container').hide()
                        }
                        
                        if (stories.length == 0 && page < 1) {
                            storiesGrid.html(`
                                <div class="empty-state">
                                    <i class="fas fa-newspaper empty-state-icon"></i>
                                    <h3>No stories found</h3>
                                    <p>Try adjusting your filters or search term</p>
                                </div>`)
                            return;
                        }
                        
                        stories.forEach(story => {
                            storiesGrid.append(`
                                <a href="/story_page/${story.id}/" 
                                   class="card-link" 
                                   aria-label="Read story: ${story.headline}">
                                    <div class="card story-card">
                                        <img src="${story.image_url}" alt="${story.headline}" class="story-card-img">
                                        <div class="story-card-content">
                                            <div class="badge badge-red">${story.category}</div>
                                            <h3 class="story-card-title">${story.headline}</h3>
                                            <p class="story-card-excerpt">${story.snippet}</p>
                                            <div class="story-card-meta">
                                                <div class="story-card-author">
                                                    <i class="fas fa-user-circle"></i>
                                                    <span>${story.author}</span>
                                                </div>
                                                <div>${story.date_and_time}</div>
                                            </div>
                                            <div class="read-more-indicator">
                                                <i class="fas fa-arrow-right"></i> Read full story
                                            </div>
                                        </div>
                                    </div>
                                </a>`
                            )
                        })
                        
                    },
                    error: function(){
                        Swal.fire({
                            title: "Error",
                            text: "An error ocured!",
                            icon: "error"
                        });
                    }
                })

            }


            function clearStoriesGrid(){
                const storiesGrid = $('#storiesList');
                storiesGrid.empty();
            }
        })




    </script>
    {% include 'partials/footer.html' %}
{% endblock %}
