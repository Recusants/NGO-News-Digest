{% extends 'partials/base.html' %}
{% load static %}

{% block title %}NGO News Digest - Home{% endblock %}

{% block content %}
    {% csrf_token %} 
    {% include 'partials/header.html' %}
    <main id="pageContent">
        <section id="home" class="page-section active">
            <div class="hero">
                <div class="container">
                    <h1>Amplifying Zimbabwe's Civil Society Impact</h1>
                    <p>Stay informed with the latest NGO stories, job vacancies, funding opportunities, and policy updates from across Zimbabwe's civil society sector.</p>
                    
                    <!-- UPDATED SUBSCRIPTION FORM WITH NAME FIELD -->
                    <div class="subscribe-form">
                        <div class="form-row">
                            <input type="text" id="subscribeName" placeholder="Your Name">
                            <input type="email" id="subscribeEmail" placeholder="Your Email">
                        </div>
                        <div class="form-group" style="text-align: left; margin-top: 1rem;">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                                <input type="checkbox" id="agreeTerms" name="agree_terms" required style="width: auto; margin-top: 0.25rem;">
                                <label for="agreeTerms" style="font-size: 0.9rem; line-height: 1.4;">
                                    I agree to the 
                                    <a href="{% url 'privacy_terms_page' %}" target="_blank" style="color: var(--primary-light); font-weight: 600;">
                                        Privacy Policy & Terms of Service
                                    </a>
                                    *
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn" id="home-subscribe-button">Subscribe Now</button>
                    </div>
                </div>
            </div>
            
            {% if featured_stories %}
                <div class="container section py-2">
                    <h2>Latest Stories</h2>
                    <div class="content-grid" id="featuredStories">
                        {% for story in featured_stories %}
                            <a href="{% url 'story_page' story.pk %}" class="card-link">
                                <div class="card story-card">
                                    <img src="{{ story.get_thumbnail_url }}" alt="{{ story.headline }}" class="story-card-img">
                                    <div class="story-card-content">
                                        <div class="badge badge-red">{{ story.category.name }}</div>
                                        <h3 class="story-card-title">{{ story.headline }}</h3>
                                        <p class="story-card-excerpt">{{ story.snippet }}</p>
                                        <div class="story-card-meta">
                                            <div class="story-card-author">
                                                <i class="fas fa-user-circle"></i>
                                                <span>{{ story.author }}</span>
                                            </div>
                                            <div>{{ story.created_at|date:"M d, Y" }}</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-2">
                        <a href="{% url 'stories_page' %}" class="btn btn-small" data-page="stories">View All Stories</a>
                    </div>
                </div>
            {% endif %}
            

            {% if featured_vacancies %}
                <div class="container section py-2" style="background-color: var(--bg-light);">
                    <h2>Urgent Vacancies</h2>
                    <div class="content-grid" id="featuredVacancies">
                        {% for vacancy in featured_vacancies %}
                            <div class="card vacancy-card" data-vacancy-id="{{ vacancy.id }}">
                                <div class="vacancy-card-header">
                                    <div>
                                        <h3 class="vacancy-title">
                                            <a href="/vacancy_page/{{ vacancy.id }}/">{{ vacancy.title|default:"Untitled Position" }}</a>
                                        </h3>
                                        <div class="vacancy-org">{{ vacancy.organization|default:"Organization not specified" }}</div>
                                    </div>
                                    {% if vacancy.urgent %}
                                        <span class="badge badge-red">Urgent</span>
                                    {% endif %}
                                    {% if vacancy.featured %}
                                        <span class="badge badge-blue">Featured</span>
                                    {% endif %}
                                </div>
                                
                                <div class="vacancy-details">
                                    <div class="vacancy-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ vacancy.location|default:"Location not specified" }}</span>
                                    </div>
                                    <div class="vacancy-detail">
                                        <i class="fas fa-briefcase"></i>
                                        <span>{{ vacancy.job_type|default:"Type not specified" }}</span>
                                    </div>
                                </div>
                                
                                <p>{{ vacancy.description|striptags|truncatechars:150|default:"No description available" }}</p>
                                
                                <div class="vacancy-deadline">
                                    <i class="far fa-calendar-alt"></i>
                                    Deadline: 
                                    {% if vacancy.expiration_date %}
                                        {{ vacancy.expiration_date|date:"M d, Y" }}
                                    {% else %}
                                        <span style="color: #999;">Not specified</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-2">
                        <a href="{% url 'vacancies_page' %}" class="btn btn-small btn-outline" data-page="vacancies">More Vacancies</a>
                    </div>
                </div>
            {% endif %}

            {% if featured_notices %}
                <div class="container section py-2">
                    <h2>Important Notices</h2>
                    <div class="content-grid" id="featuredNotices">
                        {% for notice in featured_notices %}
                            <div class="card notice-card" data-notice-id="{{ notice.id }}">
                                <div class="notice-card-header">
                                    <div class="notice-category badge">
                                        {{ notice.category }}
                                    </div>
                                    <div class="notice-date">{{ notice.created_at|date:"M d, Y" }}</div>
                                </div>
                                
                                <h3 class="notice-title">
                                    <a href="/notice_page/{{ notice.id }}/" onclick="event.stopPropagation();">{{ notice.headline }}</a>
                                </h3>
                                
                                <p class="notice-description">{{ notice.description|truncatechars:150|safe }}</p>
                                
                                <div class="notice-attachment">
                                    <i class="fas fa-paperclip"></i>
                                    <span>More details available</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-2">
                        <a href="{% url 'notices_page' %}" class="btn btn-small" data-page="notices">More Notices</a>
                    </div>
                </div>
            {% endif %}

            <div class="container section py-2">
                <h2>Our Impact in Numbers</h2>
                <div class="stats-counter">
                    <div class="stat-item">
                        <div class="stat-number" data-count="245">{{ stories_published }}</div>
                        <div class="stat-label">Stories Published</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" data-count="187">{{ jobs_listed }}</div>
                        <div class="stat-label">Jobs Listed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" data-count="532">{{ NGOs_engaged }}</div>
                        <div class="stat-label">NGOs Engaged</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" data-count="12400">{{ subscribers }}</div>
                        <div class="stat-label">Subscribers</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            function validEmail(email) {
                // Simple email validation regex
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            $('#home-subscribe-button').on('click', function() {
                var name = $('#subscribeName').val()
                var email = $('#subscribeEmail').val()
                var agreed = $('#agreeTerms').is(':checked')

                var errors = ""

                if(name == ""){
                    errors = "Please enter your name"
                } else if(!validEmail(email)){
                    errors = "Please enter a valid email"
                } else if(!agreed){  // Simplified check since agreed is boolean
                    errors = "Please agree to the terms and conditions first."
                }

                if(errors){
                    Swal.fire({
                        title: 'Error!',
                        text: errors,
                        icon: 'error'
                    });
                } else {
                    $.ajax({
                        url: '{% url "subscribe" %}',
                        method: 'POST',
                        dataType: 'json',
                        data: {
                            'name': name,
                            'email': email,
                            'agreed': agreed,
                        },
                        headers: {
                            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                        },
                        beforeSend: function() {
                            // Show loading SweetAlert
                            Swal.fire({
                                title: 'Processing...',
                                text: 'Please wait while we process your subscription',
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                        },
                        success: function(responseData) {
                            // Close loading and redirect immediately
                            Swal.close();
                            window.location.href = "{% url 'subscription_result_page' %}";
                        },
                        error: function(jqXHR) {
                            // Close loading and show error
                            Swal.close();
                            Swal.fire({
                                title: 'Error',
                                text: 'Server error. Please try again or alert the owner via contact page.',
                                icon: 'error'
                            });
                        }
                    });
                }
            })
        })
    </script>
    {% include 'partials/footer.html' %}
{% endblock %}